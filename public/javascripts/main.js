// Generated by CoffeeScript 1.4.0
(function() {
  var buildTable, handelFiles;

  document.addEventListener("dragenter", (function(e) {
    e.stopPropagation();
    e.preventDefault();
    return document.body.classList.add("show-overlay");
  }), false);

  document.addEventListener("dragover", (function(e) {
    e.stopPropagation();
    return e.preventDefault();
  }), false);

  document.addEventListener("drop", (function(e) {
    e.stopPropagation();
    e.preventDefault();
    document.body.classList.remove("show-overlay");
    return handelFiles(e.dataTransfer.files);
  }), false);

  handelFiles = function(files) {
    var i, l, _results;
    i = 0;
    l = files.length;
    _results = [];
    while (i < l) {
      if (files[i].type === "text/csv") {
        (function(file) {
          var fd, xhr;
          xhr = new XMLHttpRequest();
          fd = new FormData();
          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
              return buildTable(file, JSON.parse(xhr.responseText));
            }
          };
          fd.append("csv", file);
          xhr.open("POST", "/upload", true);
          return xhr.send(fd);
        })(files[i]);
      } else {
        alert("Don't give me that dirty file.  It's not a CSV!!");
      }
      _results.push(i++);
    }
    return _results;
  };

  buildTable = function(file, data) {
    var container, dataFirstRow, first, h, head, header, headrow, i, r, table, tableContainer, tbody, td, th, tr;
    tableContainer = document.createElement("div");
    header = document.createElement("h2");
    table = document.createElement("table");
    head = document.createElement("thead");
    headrow = document.createElement("tr");
    tbody = document.createElement("tbody");
    dataFirstRow = data.shift();
    for (h in dataFirstRow) {
      th = document.createElement("th");
      th.appendChild(document.createTextNode(dataFirstRow[h]));
      head.appendChild(th);
    }
    for (r in data) {
      tr = document.createElement("tr");
      first = true;
      for (i in data[r]) {
        if (first) {
          td = document.createElement("th");
          first = false;
        } else {
          td = document.createElement("td");
        }
        td.appendChild(document.createTextNode(data[r][i]));
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    head.appendChild(headrow);
    table.appendChild(head);
    table.appendChild(tbody);
    tableContainer.appendChild(table);
    tableContainer.classList.add("table-container");
    header.appendChild(document.createTextNode(file.name));
    container = document.getElementById("container");
    container.appendChild(header);
    return container.appendChild(tableContainer);
  };

}).call(this);
